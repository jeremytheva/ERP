# Firestore Security Rules Overview

The following guidelines map to Firestore security rules that should be implemented in `firestore.rules` and mirrored in server actions.

## Authentication Requirements
- All reads and writes require an authenticated Firebase user (anonymous sign-in is acceptable).
- A custom token claim `role` must be present and match one of the roles defined in `docs/firestore-schema.ts`.

## Collection Access Matrix
| Collection | Read | Write | Notes |
| --- | --- | --- | --- |
| `companies` | All authenticated roles | Lead role only via server actions | Prevent direct client mutations; server actions enforce validation. |
| `companyMetrics` | All authenticated roles | Server actions (automation) | Clients read-only; updates performed by backend processes. |
| `strategies` | Lead role full access, other roles read-only | Lead role via server actions | Edits go through validated Strategy Settings workflows. |
| `strategyRevisions` | Lead + contributing role | Created by server actions | Append-only history; entries tied to authenticated user id. |
| `scenarios` | Role owning the scenario | Creator role and lead | Writes validated through `ScenarioBuilder` server action. |
| `scenarioResults` | All authenticated roles | Server actions only | Generated by Genkit, never directly written by clients. |
| `actionItems` | Role assigned or lead | Assigned role can update status; lead can reassign | Enforce field-level validation with Zod on server actions. |
| `competitorNotes` | All roles read/write | All roles | Require `author` to match `request.auth.uid` for updates/deletes. |
| `reports` | All roles | Server actions only | Generated by AI flows; clients read-only. |
| `chatSessions` | Creator role and lead | Creator role and lead | Limit message creation to participants. |
| `chatMessages` | Participants of the session | Participants | Enforce message length and sanitize on server. |

## Rule Snippets
```firestore
match /databases/{database}/documents {
  function isAuthenticated() {
    return request.auth != null && request.auth.token.role in [
      'sales', 'procurement', 'production', 'logistics', 'lead'
    ];
  }

  function hasRole(role) {
    return isAuthenticated() && request.auth.token.role == role;
  }

  match /companies/{companyId} {
    allow read: if isAuthenticated();
    allow write: if hasRole('lead') && request.time == request.resource.data.lastUpdatedAt;
  }

  match /companies/{companyId}/strategies/{strategyId} {
    allow read: if isAuthenticated();
    allow write: if hasRole('lead');
  }

  match /companies/{companyId}/actionItems/{actionItemId} {
    allow read: if isAuthenticated();
    allow write: if isAuthenticated() && (
      request.auth.uid == resource.data.assignedTo || hasRole('lead')
    );
  }
}
```

## Server Action Responsibilities
- Wrap every Firestore mutation with Zod validation using types from `firestore-schema.ts`.
- Enforce role-based logic before writing to Firestore.
- Sanitize AI-generated content prior to persistence.
- Emit analytics logs for auditable operations (strategy updates, scenario runs, report generation).
